apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agenticsessions.vteam.ambient-code
spec:
  group: vteam.ambient-code
  versions:
  - name: v1alpha1
    served: true
    storage: true
    subresources:
      status: {}
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              # Repository configuration
              repos:
                type: array
                description: "List of Git repositories to clone and work with"
                items:
                  type: object
                  required:
                  - url
                  properties:
                    url:
                      type: string
                      description: "Git repository URL"
                    branch:
                      type: string
                      description: "Branch to checkout"
                      default: "main"
              interactive:
                type: boolean
                description: "When true, run session in interactive chat mode using inbox/outbox files"
                default: true
              prompt:
                type: string
                description: "Optional initial prompt for the agentic session. If using a workflow with startupPrompt in ambient.json, this can be omitted."
              displayName:
                type: string
                description: "A descriptive display name for the agentic session generated from prompt and website"
              userContext:
                type: object
                description: "Authenticated caller identity captured at creation time (used for authorization and audit)"
                properties:
                  userId:
                    type: string
                    description: "Stable user identifier (from SSO, always overwritten from auth token)"
                  displayName:
                    type: string
                    description: "Human-readable display name"
                  groups:
                    type: array
                    items:
                      type: string
                    description: "Group memberships of the user"
              llmSettings:
                type: object
                properties:
                  model:
                    type: string
                    default: "claude-3-7-sonnet-latest"
                  temperature:
                    type: number
                    default: 0.7
                  maxTokens:
                    type: integer
                    default: 4000
                description: "LLM configuration settings"
              timeout:
                type: integer
                default: 300
                description: "Timeout in seconds for the agentic session"
              autoPushOnComplete:
                type: boolean
                default: false
                description: "When true, the runner will commit and push changes automatically after it finishes"
              activeWorkflow:
                type: object
                description: "Active workflow configuration for dynamic workflow switching"
                properties:
                  gitUrl:
                    type: string
                    description: "Git repository URL for the workflow"
                  branch:
                    type: string
                    description: "Branch to clone"
                    default: "main"
                  path:
                    type: string
                    description: "Optional path within repo (for repos with multiple workflows)"
          status:
            type: object
            properties:
              phase:
                type: string
                enum:
                - "Pending"
                - "Creating"
                - "Running"
                - "Completed"
                - "Failed"
                - "Stopped"
                - "Error"
                default: "Pending"
              message:
                type: string
                description: "Status message or error details"
              is_error:
                type: boolean
                description: "Whether the run ended with an error"
  scope: Namespaced
  names:
    plural: agenticsessions
    singular: agenticsession
    kind: AgenticSession
    shortNames:
    - as
